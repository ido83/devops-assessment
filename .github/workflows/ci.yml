# SecAssess v15 â€” CI/CD Pipeline
# Triggers: Push to main, PRs to main
# Gates: Secret scanning (Gitleaks), SAST (Semgrep), linting, SCA (npm audit), SBOM, SemVer bump
name: SecAssess CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  security-events: write

env:
  NODE_VERSION: '20'

jobs:
  # â”€â”€ Gate 1: Secret Scanning with Gitleaks â”€â”€
  secret-scan:
    name: ðŸ” Secret Scanning (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€ Gate 2: SAST with Semgrep â”€â”€
  sast:
    name: ðŸ” SAST (Semgrep)
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - uses: actions/checkout@v4
      - name: Run Semgrep
        run: semgrep scan --config auto --error --json --output semgrep-results.json . || true
      - name: Upload SAST results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-results
          path: semgrep-results.json

  # â”€â”€ Gate 3: Lint & Test â”€â”€
  lint-test:
    name: ðŸ§ª Lint & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            frontend/package-lock.json
            backend/package-lock.json

      - name: Install frontend deps
        working-directory: frontend
        run: npm ci --legacy-peer-deps

      - name: Build frontend (compile check)
        working-directory: frontend
        env:
          REACT_APP_API_URL: /api
          CI: false
        run: npm run build

      - name: Install backend deps
        working-directory: backend
        run: npm ci

      - name: Syntax check backend
        working-directory: backend
        run: node -c server.js

  # â”€â”€ Gate 4: SCA â€” Dependency Audit â”€â”€
  sca:
    name: ðŸ“¦ SCA (npm audit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Audit frontend
        working-directory: frontend
        run: |
          npm install --legacy-peer-deps
          npm audit --audit-level=critical || true

      - name: Audit backend
        working-directory: backend
        run: |
          npm install
          npm audit --audit-level=critical || true

  # â”€â”€ Generate SBOM â”€â”€
  sbom:
    name: ðŸ“‹ Generate SBOM
    runs-on: ubuntu-latest
    needs: [lint-test]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install frontend deps
        working-directory: frontend
        run: npm install --legacy-peer-deps

      - name: Install backend deps
        working-directory: backend
        run: npm install

      - name: Generate SBOM (CycloneDX)
        run: |
          npx @cyclonedx/cyclonedx-npm --output-file frontend-sbom.json frontend/
          npx @cyclonedx/cyclonedx-npm --output-file backend-sbom.json backend/

      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            frontend-sbom.json
            backend-sbom.json

  # â”€â”€ SemVer Bump (on push to main only) â”€â”€
  version-bump:
    name: ðŸ·ï¸ SemVer Bump
    runs-on: ubuntu-latest
    needs: [secret-scan, sast, lint-test, sca]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version bump
        id: bump
        run: |
          # Check commit messages for bump hints
          LAST_MSG=$(git log -1 --pretty=%B)
          if echo "$LAST_MSG" | grep -qi "BREAKING CHANGE\|^feat!"; then
            echo "bump=major" >> $GITHUB_OUTPUT
          elif echo "$LAST_MSG" | grep -qi "^feat"; then
            echo "bump=minor" >> $GITHUB_OUTPUT
          else
            echo "bump=patch" >> $GITHUB_OUTPUT
          fi

      - name: Bump version
        run: |
          # Get latest tag or default to v0.0.0
          LATEST=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          VERSION=${LATEST#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          case "${{ steps.bump.outputs.bump }}" in
            major) MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0;;
            minor) MINOR=$((MINOR+1)); PATCH=0;;
            patch) PATCH=$((PATCH+1));;
          esac
          
          NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
          echo "Bumping to $NEW_TAG (${{ steps.bump.outputs.bump }})"
          git tag -a "$NEW_TAG" -m "Release $NEW_TAG"
          git push origin "$NEW_TAG"
